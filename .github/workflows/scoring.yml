name: GNN Challenge Auto-Grader

on:
  pull_request:
    paths:
      - 'submissions/**/*.enc'

permissions:
  contents: write
  pull-requests: write

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install pandas scikit-learn rsa

      # 1. DECRYPT THE SUBMISSION
      - name: Decrypt Submission
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: python competition/decrypt.py

      # 2. VALIDATE SUBMISSION (Enforce "One Submission" Rule)
      - name: Validate Submission
        run: |
          # Find the decrypted CSV (ignoring the sample file)
          # This works regardless of whether the file is named 'TeamA.csv' or 'submission.csv'
          FILE_PATH=$(ls submissions/*.csv | grep -v "sample_submission.csv" | head -n 1)

          if [ -z "$FILE_PATH" ]; then
            echo "::error::No decrypted CSV found! Decryption might have failed."
            exit 1
          fi

          echo "ðŸ” Validating: $FILE_PATH"

          # USE THE CSV PATH HERE (So pd.read_csv works)
          python competition/validate_submission.py "$FILE_PATH" "data/public/test_nodes.csv" "leaderboard/leaderboard.csv"


      # 3. RESTORE HIDDEN ANSWER KEY
      - name: Restore Secret Answer Key
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
        run: |
          echo "$TEST_LABELS" | base64 -d | gzip -d > data/test_labels_hidden.csv

      # 4. RUN SCORING
      - name: Run Scoring Script
        id: score
        run: |
          # Find the file again
          FILE_PATH=$(ls submissions/*.csv | grep -v "sample_submission.csv" | head -n 1)
          
          # Run evaluation
          OUTPUT=$(python competition/evaluate.py "$FILE_PATH" "data/test_labels_hidden.csv")
          
          echo "$OUTPUT"
          
          # Extract score (Looking for "SCORE=0.xxxx")
          SCORE=$(echo "$OUTPUT" | grep -oP 'SCORE=\K[0-9.]+')
          echo "extracted_score=$SCORE" >> $GITHUB_OUTPUT

      # 5. POST COMMENT
      - name: Comment on PR
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ### ðŸ¤– Automated Grading Report
            | Metric | Score | Status |
            | :--- | :--- | :--- |
            | **Macro F1** | **${{ steps.score.outputs.extracted_score }}** | âœ… Valid |
            
            *The leaderboard will be updated if this PR is merged.*
