name: GNN Challenge Auto-Grader

on:
  pull_request:
    paths:
      # CHANGED: Now watches for encrypted files
      - 'submissions/**/*.enc'

permissions:
  contents: write
  pull-requests: write

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install pandas scikit-learn rsa

      # --- NEW STEP: Decrypt the Student's Submission ---
      - name: Decrypt Submission
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          # Run the decryption script we created earlier
          # This will create 'submissions/submission.csv' from the .enc file
          python competition/decrypt.py
      # --------------------------------------------------

      - name: Restore Secret Answer Key
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
        run: |
          # Decodes your hidden ground truth labels
          echo "$TEST_LABELS" | base64 -d | gzip -d > data/test_labels_hidden.csv

      - name: Run Scoring Script
        id: score
        run: |
          # We now point to the DECRYPTED file (submission.csv)
          # Note: We hardcoded the output path in decrypt.py to 'submissions/submission.csv'
          FILE_PATH="submissions/submission.csv"
          
          # Run evaluation
          OUTPUT=$(python competition/evaluate.py "$FILE_PATH" "data/test_labels_hidden.csv")
          
          echo "$OUTPUT"
          
          # Extract score (Looking for "SCORE=0.xxxx")
          SCORE=$(echo "$OUTPUT" | grep -oP 'SCORE=\K[0-9.]+')
          echo "extracted_score=$SCORE" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: tholman/github-action-comment-pull-request@v2
        with:
          message: |
            ### ðŸ¤– Automated Grading Report
            | Metric | Score | Status |
            | :--- | :--- | :--- |
            | **Macro F1** | **${{ steps.score.outputs.extracted_score }}** | âœ… Valid |
            
            *The leaderboard will be updated if this PR is merged.*
